# 토스페이먼츠를 통한 결제 연동 시스템 및 프로필 조회수 증가 캐싱 안전성 확보

## 프로젝트 개요

- 토스페이먼츠 결제 API 연동 처리 과정에서 발생하는 다양한 시나리오에서 안전성 확보를 목표로 한다.
- 결제 승인, 검증, 재시도 가능한 오류 처리와 결제 상태 관리를 통해 시스템 안전성을 중점으로 둔다.
- 프로필 상세 조회 시 추가적인 조회수 증가 I/O 성능 저하 및 동시성 안전을 목표로 한다.

<br>

## 해결 과제
- 소프트웨어 아키텍쳐 설계 : 도메인의 결합도 및 의존성을 감소를 위한 아키텍쳐 설계
- 결제 데이터 정합성 : 결제 요청, 승인 과정에서 데이터 불일치 및 무결성 깨짐을 방지하기 위한 데이터 검증
- 조회수 증가의 동시성 및 동기화 : InMemory 캐싱 시 발생할 수 있는 조회수 동시성 문제 및 데이터 일관성 확보
- API 응답 지연 및 서버 다운 : 스케줄링 데이터 복구 로직을 통해 항상 일관되고, 안정적인 결제 처리 및 조회수 증가 설계

<br>

## 구성 API


| 기능 | URL                                       | 메소드 | 설명                          |
|:--------|:---------------------------------------|--------|-------------------------------|
| 회원가입   | /api/members/signup                  | POST   | 간단한 회원가입 |
| 회원 프로필 상세 조회   | /api/profiles/{profileId}| GET    | 회원 ID로 프로필 조회 및 조회수 증가 |
| 회원 프로필 리스트 조회 | /api/profiles            | GET    | 필터링 조건에 부합하는 회원 목록 조회 |
| Toss 결제 정보 생성   | /api/payments/toss/checkout | POST | Toss 결제 전 사용자 결제 정보 생성 및 응답 |
| Toss 결제 승인 요청   | /api/payments/toss/confirm | POST | Toss 결제 승인 전 사용자 검증 및 결제 상태 처리 |

<br>

## 패키지 구조 및 의존성

![image](https://github.com/user-attachments/assets/eabf7d5e-f91f-4204-b0b1-0d4bdd5e7f57)

## 핵심 기능 구현

### 프로필 조회수 증가 처리 및 장애 복구 설계

url : /api/profiles/{profileId}

**🧩 문제 정의**
- 조회수가 DB에 실시간 저장되면 부하가 큼
- 캐싱되지 않은 상태에서 여러명의 동시 사용자가 서로 캐싱하려는 경우
- 어제 일자의 캐싱된 조회수가 DB에 동기화 되어있지 않고 캐시에 남아있는 경우 조회의 조회수 일관성
- Redis 삽입 시 예외가 발생할 경우 loss 조회수 관리

**⚙️ 설계 및 구현 핵심 키워드**
- Redis 캐싱 조회수 저장
- 날짜별 키 관리 ('profile:view:{id}:{yyyyMMdd}')
- setIfAbsent + INCR 중복 캐싱 동시성 대응 및 조회수 일관성 확보
- Redis 장애 대비 History 저장 및 DB 조회수 동기화 스케줄링

**🔁 조회수 증가 흐름 설명**

![image](https://github.com/user-attachments/assets/e745e45e-3b24-4d57-a24e-cf5902e705aa)

요약 : 프로필이 조회될 때 마다 profileId + yyyy-mm-dd 정보로 캐싱되며, 해당 정보로 캐시의 유무를 판단하여 캐싱하고, 하루마다 자정이 지나면 스케줄링을 통해 캐시된 조회수를 DB에 동기화한다.




