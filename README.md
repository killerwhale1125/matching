# 토스페이먼츠를 통한 결제 연동 시스템 및 프로필 조회수 증가 캐싱 성능 개선

## 프로젝트 개요

- 토스페이먼츠 결제 API 연동 처리 과정에서 발생하는 다양한 시나리오에서 안전성 확보를 목표로 한다.
- 결제 승인, 검증, 재시도 가능한 오류 처리와 결제 상태 관리를 통해 시스템 안전성을 중점으로 둔다.
- 프로필 상세 조회 시 추가적인 조회수 증가 I/O 성능 저하의 개선을 목표로 한다.

<br>

## 해결 과제
- 아키텍쳐 설계 : 도메인의 결합도 및 의존성을 감소를 위한 아키텍쳐 설계
- 결제 데이터 정합성 : 결제 요청, 승인 과정에서 데이터 불일치 및 무결성 깨짐을 방지하기 위한 데이터 검증
- 조회수 증가의 동시성 및 동기화 : InMemory 캐싱 시 발생할 수 있는 조회수 동시성 문제 및 데이터 일관성 확보
- API 응답 지연 및 서버 다운 : 스케줄링 데이터 복구 로직을 통해 항상 일관되고, 안정적인 결제 처리 및 조회수 증가 설계

<br>

## 핵심 기능 구현

**프로필 조회수 증가 처리 및 장애 복구 설계**

url : /api/profiles/{profileId}

1. 오늘 날짜 기준 Redis 키 존재 여부 확인
- Redis에 profile:view:{profileId}:{yyyyMMdd} 형태의 키가 존재하는지 확인합니다.

2. 오늘자 키가 존재하는 경우 (Cache Hit)
- Redis의 INCR 명령어 원자적(atomic) 으로 +1 증가시킵니다.

3. 오늘자 키가 존재하지 않는 경우 (Cache Miss)
- 먼저 어제 날짜의 Redis 키를 조회하여 이전 조회수를 참조합니다. (새벽 1시 스케줄링이 진행되지만, DB와 동기화 안되어 있을 가능성으로 인해)
- 어제 날짜의 키도 없을 경우 DB에서 현재 조회수를 조회합니다.
- 이후 다음과 같이 Redis에 캐싱을 시도합니다:
  - Redis의 setIfAbsent를 사용해 viewCount + 1을 신규 삽입 시도합니다.
  - 만약 이미 다른 쓰레드나 요청에서 키가 삽입된 경우 (setIfAbsent 실패),
    INCR을 다시 수행하여 정확하게 +1 증가시킵니다.

4. 최종적으로 증가된 조회수 값을 Profile 객체에 반영하여 반환합니다.

